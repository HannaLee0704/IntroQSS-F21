---
title: "PLSC30500, Fall 2021"
subtitle: "2.1 Data wrangling 1"
# author: "Andy Eggers & Molly Offer-Westort"
output: 
  xaringan::moon_reader:
    self_contained: true
    css: [default, uoc_meth.css]
    nature:
      highlightLines: true

---

```{r setup, include=FALSE}
library(tidyverse)
```

```{css, echo=FALSE}
.small-output .remark-code{
  font-size: x-small;
}
```

# The big picture 

Components of a `ggplot`: 

- "tidy" data, with observations in rows, attributes in columns
- mapping of attributes to aesthetics (x, y, size, shape, color, transparency, etc)
- geometric objects (`geom`s)

This week: "data wrangling" to prepare data for plotting (and analysis).


---

class: inverse, middle, center

# Some key data wrangling tools in `dplyr`: `select()`, `filter()`, `group_by()`, `summarize()`, `mutate()`

---

# Load V-Dem dataset

1. Install the installer: `install.packages("devtools")`
1. Install the package from github: `devtools::install_github("vdeminstitute/vdemdata")`
1. Load the package: `library(vdemdata)`

```{r echo = F}
library(vdemdata)
```


Now by typing `vdem` you can access the dataset.


???

Can also get necessary subset on repository: data/vdem_long_extract.csv


---

# Getting a feel for the data (1)

`vdem` is big! 

```{r}
dim(vdem)
```

--

Typing `vdem` is overwhelming and unhelpful; `View(vdem)` better but takes a while to load. 

---

#### Look at column names: 

.small-output[
```{r}
names(vdem)  # colnames(vdem) also works
```
]

---


#### `tibble`s: better viewing

<!-- see
https://github.com/yihui/xaringan/issues/169
for shortcut
--> 

.small-output[
```{r}
vdem %>% as_tibble()   # "tibble" package is part of "tidyverse"
```
]


---

#### The "pipe": `%>%`

Equivalent code:
```{r, eval = F}
as_tibble(vdem)
vdem %>% as_tibble()
```

```{r, eval = F}
mean(c(1,2,3))
c(1,2,3) %>% mean()
```

Can be more readable.

---

### Pick out columns with `select()`



```{r}
vd <- as_tibble(vdem)
vd %>% 
  select(country_text_id, year, e_regionpol_6C, 
         v2x_polyarchy, e_migdppc)
```

---


### Pick out rows with `filter()`

```{r}
vd %>% 
  select(country_text_id, year, e_regionpol_6C, 
         v2x_polyarchy, e_migdppc) %>% 
  filter(year == 2015) #<<
```

---

### Create new variables with `mutate()`

```{r}
vd %>% 
  select(country_text_id, year, e_regionpol_6C, v2x_polyarchy, e_migdppc) %>% 
  filter(year == 2015) %>% 
  mutate(polyarchy_times_100 = 100*v2x_polyarchy) %>% #<<
  select(country_text_id, year, v2x_polyarchy, polyarchy_times_100)
```

---


### Plotting democratization for each country 

```{r fig.height=4.5, fig.width=9, fig.align="center", message = F, warning = F}
vd %>% 
  filter(year > 1900) %>% 
  ggplot(aes(x = year, y = v2x_polyarchy, 
             group = country_name)) + 
  geom_line(alpha = .5)
```

---

### Plotting democratization for each country (2)

```{r fig.height=4.5, fig.width=9, fig.align="center", message = F, warning = F}
vd %>% 
  filter(year > 1900) %>% 
  ggplot(aes(x = year, y = v2x_polyarchy, 
             group = country_name, 
             col = factor(e_regionpol_6C))) +  #<<
  geom_line(alpha = .5)
```

---

### Extract column summaries with `summarize()`

```{r}
vd %>% 
  filter(year == 2015) %>% 
  summarize(mean_poly = mean(v2x_polyarchy, na.rm = T),
            mean_gdppc = mean(e_migdppc, na.rm = T))
```

--

A "base `R`" alternative: 

```{r}
apply(vd[vd$year == 2015, c("v2x_polyarchy", "e_migdppc")],
      2, mean, na.rm = T)
```

---

### Why `na.rm = T`? 

```{r}
vd %>% 
  filter(year == 2015) %>% 
  summarize(mean_poly = mean(v2x_polyarchy),
            mean_gdppc = mean(e_migdppc)) 
```


---

### Grouped summaries

```{r}
vd %>% 
  filter(year > 1900) %>% 
  group_by(year) %>%  #<<
  summarize(mean_poly = mean(v2x_polyarchy, na.rm = T),
            mean_gdppc = mean(e_migdppc, na.rm = T))
```

---

### Plotting grouped summaries 


```{r fig.height=4.5, fig.width=9, fig.align="center"}
vd %>% 
  filter(year > 1900) %>% 
  group_by(year) %>%
  summarize(mean_poly = mean(v2x_polyarchy, na.rm = T),
            mean_gdppc = mean(e_migdppc, na.rm = T)) %>% 
  ggplot(aes(x = year, y = mean_poly)) +  #<<
  geom_line()  #<<
```


---

### Alternative way to do something similar


```{r fig.height=4.5, fig.width=9, fig.align="center", warning = F, message = F}
vd %>% 
  filter(year > 1900) %>% 
  ggplot(aes(x = year, y = v2x_polyarchy)) +  #<<
  geom_smooth(span = .5)  #<<
```


---


### Plotting grouped summaries (2)


```{r fig.height=4.5, fig.width=10.5, fig.align="center", warning = F}
vd %>% 
  filter(year > 1900) %>% 
  group_by(year) %>%
  summarize(mean_poly = mean(v2x_polyarchy, na.rm = T),
            mean_gdppc = mean(e_migdppc, na.rm = T)) %>% 
  mutate(my_size = ifelse(year %in% c(1946, 1960, 1989, 2018), 8, 0)) %>% 
  ggplot(aes(x = mean_gdppc, y = mean_poly)) +  #<<
  geom_path() + 
  geom_point() + 
  geom_text(aes(label = year, size = my_size), show.legend=F)
```


---


### Plotting grouped summaries (3)


```{r fig.height=4.5, fig.width=9, fig.align="center", message = F}
vd %>% 
  filter(year > 1900) %>% 
  group_by(year, e_regionpol_6C) %>% #<<
  summarize(mean_poly = mean(v2x_polyarchy, na.rm = T),
            mean_gdppc = mean(e_migdppc, na.rm = T)) %>% 
  ggplot(aes(x = year, y = mean_poly, col = factor(e_regionpol_6C))) +  #<<
  geom_line()
```

???

1: Eastern Europe and Central Asia (including Mongolia and German Democratic Republic)
2: Latin America and the Caribbean
3: The Middle East and Northern Africa (including Israel and Turkey, excluding Cyprus)
4: Sub-Saharan Africa
5: Western Europe and North America (including Cyprus, Australia and New Zealand, but
excluding German Democratic Republic)
6: Asia and Pacific (excluding Australia and New Zealand; see 5)


<!-- This seems a little thin. What else could we do with class time? Start Thursday stuff I guess. --> 
